# Task: Build Advanced Pixel Art Drawing Web Application with Layer System and Color Management

## Plan
- [x] Step 1: Create type definitions and data models (Completed)
  - [x] Define Color, Pixel, Tool, AppState types
  - [x] Create Point interface
  - [x] Add advanced tool types (line, circle, square, marquee, lasso, hand, move)
  - [x] Add Selection, FillMode, Clipboard types
  - [x] Add Layer and BlendMode types
- [x] Step 2: Implement utility functions (Completed)
  - [x] Flood fill algorithm for fill tool (contiguous mode)
  - [x] Global fill algorithm (replace all instances)
  - [x] Bresenham's line algorithm
  - [x] Midpoint circle algorithm
  - [x] Rectangle drawing algorithm
  - [x] PNG export functionality
  - [x] Canvas initialization helper
  - [x] Transformation functions (rotate, flip horizontal, flip vertical)
  - [x] Selection utilities (extract, paste, clear)
  - [x] Point-in-polygon detection for lasso
  - [x] Blend mode algorithms (12 modes)
  - [x] Layer management utilities (create, duplicate, delete, reorder, merge)
- [x] Step 3: Create custom hooks (Completed)
  - [x] useHistory hook for undo/redo
  - [x] usePixelCanvas hook for canvas rendering
  - [x] useKeyboardShortcuts hook with extended shortcuts
- [x] Step 4: Build core components (Completed)
  - [x] EnhancedPixelCanvas component with all tools
  - [x] DrawingToolbar component (pencil, eraser, fill, eyedropper, line, circle, square)
  - [x] SelectionToolbar component (marquee, lasso, move, hand)
  - [x] ColorPicker component with palette
  - [x] Controls component
  - [x] TransformControls component (fill mode, rotate, flip)
  - [x] LayerPanel component with drag-and-drop reordering
  - [x] LayerItem component with all layer properties
- [x] Step 5: Create main application page (Completed)
  - [x] Integrate all components
  - [x] Implement state management with layers
  - [x] Add keyboard shortcuts
  - [x] Add clipboard operations (copy, cut, paste)
  - [x] Add transformation operations
  - [x] Add layer management (create, delete, duplicate, reorder)
- [x] Step 6: Update routing and polish (Completed)
  - [x] Update routes.tsx to show pixel art editor
  - [x] Add responsive design
  - [x] Test all features
- [x] Step 7: Mobile optimization (Completed)
  - [x] Fixed viewport layout (no scrolling)
  - [x] Drawer-based controls using Sheet component
  - [x] Touch event support for canvas
  - [x] Responsive canvas sizing
  - [x] Optimized button sizes for touch (48px minimum)
- [x] Step 8: Advanced features implementation (Completed)
  - [x] Shape primitives with integer-based algorithms
  - [x] Enhanced bucket fill with contiguous/global modes
  - [x] Selection tools (marquee and lasso)
  - [x] Clipboard operations (Ctrl+C, Ctrl+X, Ctrl+V)
  - [x] Transformations (rotate 90°, flip horizontal, flip vertical)
  - [x] Pan tool (hand) for navigation
  - [x] Selection overlay visualization
- [x] Step 9: Layer system implementation (Completed)
  - [x] Layer creation, deletion, duplication
  - [x] Layer reordering via drag-and-drop
  - [x] Opacity control (0-100%)
  - [x] Visibility toggle
  - [x] Layer locking
  - [x] Alpha lock
  - [x] Blend modes (12 modes)
  - [x] Layer merging for display
- [x] Step 10: Color and palette management (Completed)
  - [x] Enhanced color picker with RGB/HSV sliders
  - [x] Hex code input with validation
  - [x] Palette manager with create/save/delete
  - [x] Import/export palettes (JSON and GPL formats)
  - [x] Drag-and-drop color sorting in palettes
  - [x] Default palettes (Default, Grayscale, PICO-8)
  - [x] Add/remove colors from palettes
  - [x] Color conversion utilities (RGB/HSV/Hex)
- [x] Step 11: Dynamic brush modes (Completed)
  - [x] Normal mode (standard drawing)
  - [x] Rainbow mode (cycles hue per stroke)
  - [x] Random mode (random palette color per pixel)
  - [x] Dither mode (Bayer matrix patterns)
  - [x] Dither pattern selector (2x2, 4x4, 8x8)
  - [x] Brush mode selector component
- [x] Step 12: Run lint and fix any issues (Completed)
- [x] Step 13: Reorganize UI layout for better accessibility (Completed)
  - [x] Move controls to top toolbar above canvas
  - [x] Reorganize layout: Header → Top Toolbar → Canvas → Status Bar
  - [x] Larger, more accessible color selector (12x12px with hover effect)
  - [x] Prominent Export button in header
  - [x] Larger action buttons (10x10px) with tooltips
  - [x] Better visual hierarchy and spacing
  - [x] Improved icon sizes for better visibility
- [x] Step 14: Fix critical bugs (Completed)
  - [x] Fixed blend modes not working (canvas now displays merged layers with blend modes applied)
  - [x] Consolidated shapes into dropdown menu (Line, Circle, Rectangle in single dropdown)
  - [x] Fixed undo/redo functionality (history hook working correctly)
  - [x] Updated handlePixelChange to correctly update active layer from merged canvas
  - [x] Simplified toolbar to single row with shapes dropdown
  - [x] Added visual separator between tool groups
- [x] Step 15: Mobile optimization (Completed)
  - [x] Responsive toolbar layout (stacked on mobile, single row on desktop)
  - [x] Touch-friendly button sizes (44x44px on mobile, 40x40px on desktop)
  - [x] Mobile-first responsive breakpoints using sm: prefix
  - [x] Horizontal scrolling for drawing tools on small screens
  - [x] Full-width sheets on mobile, fixed width on desktop
  - [x] Optimized spacing and padding for mobile (reduced px-2, py-2)
  - [x] Responsive typography (smaller text on mobile)
  - [x] Active touch feedback (active:scale-95 on mobile)
  - [x] Condensed status bar on mobile (hide layer details)
  - [x] Larger color sheet height on mobile (85vh vs 80vh)
- [x] Step 16: Fix undo/redo functionality (Completed)
  - [x] Refactored useHistory hook to use refs for tracking current state
  - [x] Fixed stale closure issues in undo/redo callbacks
  - [x] Eliminated race conditions in state updates
  - [x] Proper history management with refs (historyRef, currentIndexRef)
  - [x] Callbacks now use latest values via refs instead of dependencies
  - [x] History correctly captures all state changes
  - [x] Undo/redo now properly navigate through history stack
- [x] Step 17: Fix React hooks order violation (Completed)
  - [x] Moved useEffect hook to come immediately after useKeyboardShortcuts
  - [x] Ensured all hooks are called in consistent order on every render
  - [x] Fixed "Rendered more hooks than during the previous render" error
  - [x] Proper hook ordering: useState → useMemo → useHistory → useKeyboardShortcuts → useEffect → function definitions
- [x] Step 18: Implement customizable canvas size and tool simplification (Completed)
  - [x] Added canvasWidth and canvasHeight to EditorState
  - [x] Created CanvasSizeSettings component with presets (16×16, 32×32, 64×64, 128×128)
  - [x] Added custom size input (8-256 pixels range)
  - [x] Implemented handleCanvasSizeChange to resize all layers
  - [x] Added canvas size button in header showing current dimensions
  - [x] Removed marquee, lasso, and hand tools
  - [x] Renamed "marquee" to "select" tool for rectangular selection
  - [x] Updated move tool to work with selections
  - [x] Updated keyboard shortcuts (M for select, removed H for hand)
  - [x] Simplified SelectionToolbar to only show Select and Move tools
  - [x] Updated PixelCanvas to handle select and move tools properly
  - [x] Move tool now allows dragging selected areas
- [x] Step 19: Fix canvasGrid undefined error in use-pixel-canvas hook (Completed)
  - [x] Added validation check for canvasGrid existence before rendering
  - [x] Added Array.isArray check to ensure canvasGrid is valid array
  - [x] Added length check to ensure canvasGrid is not empty
  - [x] Added safety checks for row existence (canvasGrid[y]) before accessing
  - [x] Added safety checks for cell existence (canvasGrid[y][x]) before accessing
  - [x] Prevents "Cannot read properties of undefined (reading '0')" error
  - [x] Hook now gracefully handles undefined or malformed canvasGrid data
- [x] Step 20: Detach transform controls and improve export quality (Completed)
  - [x] Created separate Transform sheet with FlipHorizontal2 icon
  - [x] Moved transform button next to Layers button in toolbar
  - [x] Removed Transform tab from Controls sheet
  - [x] Updated Controls sheet description to "Export and manage your canvas"
  - [x] Updated Transform sheet with dedicated UI for rotate/flip operations
  - [x] Improved export quality with 8x scaling factor (256×256 becomes 2048×2048)
  - [x] Added high quality PNG export settings (quality: 1.0)
  - [x] Disabled image smoothing for crisp pixel art export
  - [x] Export now uses dynamic canvas dimensions (canvasWidth × canvasHeight)
  - [x] Ensured exported images are larger than 200KB
  - [x] Added safety checks for mergedCanvas array access during export
- [x] Step 21: Fix Tabs component runtime error (Completed)
  - [x] Rewrote Tabs component using React.forwardRef pattern
  - [x] Converted all tab components (Tabs, TabsList, TabsTrigger, TabsContent) to forwardRef
  - [x] Added displayName to all components for better debugging
  - [x] Changed from function declarations to const declarations with explicit types
  - [x] Used React.ComponentPropsWithoutRef for proper prop typing
  - [x] Maintained all className and styling from original implementation
  - [x] Verified exports are correct and match shadcn/ui patterns
  - [x] All 96 files passed lint checks
- [x] Step 22: Implement full stack pixel art theme (Completed)
  - [x] Added Google Fonts: Press Start 2P (pixel font) and VT323 (retro monospace)
  - [x] Updated color palette with retro 8-bit/16-bit inspired colors
  - [x] Changed primary to bright blue (220 100% 50%), secondary to hot pink/magenta (340 100% 50%)
  - [x] Set accent to bright yellow (50 100% 50%) for highlights
  - [x] Updated border colors to dark blue with high contrast
  - [x] Set border-radius to 0rem for sharp pixel aesthetic corners
  - [x] Created custom pixel utilities: pixel-border, pixel-button, pixel-card, pixel-inset
  - [x] Added pixel effects: pixel-scanlines, pixel-grid, pixel-glow, pixel-text-shadow
  - [x] Implemented pixel-crisp class for sharp image rendering
  - [x] Added pixel animations: pixel-blink, pixel-pulse
  - [x] Extended Tailwind with pixel shadow utilities (shadow-pixel, shadow-pixel-sm, shadow-pixel-lg)
  - [x] Added font-pixel and font-retro font families to Tailwind config
  - [x] Updated header with "PIXEL ART PRO" title using pixel font and text shadow
  - [x] Applied pixel-grid background to main container
  - [x] Added pixel-card and shadow-pixel effects to header
  - [x] Updated color selector with pixel-button and border-4 styling
  - [x] Applied pixel-button class to all toolbar buttons (Undo, Redo, Layers, Transform, Controls)
  - [x] Updated sheet headers with font-pixel for titles and font-retro for descriptions
  - [x] Added border-l-4 to side sheets for pixel aesthetic
  - [x] Applied pixel-inset effect to toolbar container
  - [x] Set body font to VT323 for better readability with pixel aesthetic
  - [x] All 96 files passed lint checks
- [x] Step 23: Convert Transform and Controls to dropdown menus (Completed)
  - [x] Imported DropdownMenu components from shadcn/ui
  - [x] Added icons: RotateCw, FlipVertical2, Grid3x3, Trash2 from lucide-react
  - [x] Replaced Transform Sheet with DropdownMenu
  - [x] Added Transform dropdown with Rotate 90°, Flip Horizontal, Flip Vertical options
  - [x] Replaced Controls Sheet with DropdownMenu (renamed to "OPTIONS")
  - [x] Added Options dropdown with Show/Hide Grid and Clear Canvas options
  - [x] Applied pixel-card styling with border-4 to dropdown menus
  - [x] Used font-pixel for dropdown labels and font-retro for menu items
  - [x] Set dropdown width to w-56 for consistent sizing
  - [x] Added h-[2px] separators with bg-border for pixel aesthetic
  - [x] Increased menu item padding to py-3 for better touch targets
  - [x] Applied text-destructive color to Clear Canvas option
  - [x] Removed unused state variables: controlsOpen, transformOpen
  - [x] Removed setControlsOpen call from handleClear function
  - [x] Removed unused TransformControls and Controls component imports
  - [x] All 96 files passed lint checks
- [x] Step 24: Apply pixel theme to Canvas Size dialog (Completed)
  - [x] Added pixel-card class with border-4 to DialogContent
  - [x] Applied font-pixel class to dialog title "CANVAS SIZE" with text-primary and text-sm
  - [x] Applied font-retro class to dialog description with text-base
  - [x] Added font-retro text-base to "Presets" label
  - [x] Applied pixel-button and font-retro classes to all preset buttons
  - [x] Added font-retro text-base to Width and Height labels
  - [x] Applied pixel-inset and font-retro text-base classes to input fields
  - [x] Added font-retro class to current size display text
  - [x] Applied pixel-button and font-retro classes to Cancel and Apply buttons
  - [x] Canvas size dialog now fully functional with pixel theme styling
  - [x] All 96 files passed lint checks
- [x] Step 25: Fix dynamic canvas size boundary error (Completed)
  - [x] Identified root cause: hardcoded GRID_SIZE constant (32) used for boundary checks
  - [x] Added gridHeight and gridWidth calculations from actual canvasGrid dimensions
  - [x] Updated getPixelCoords to use actual grid dimensions instead of GRID_SIZE
  - [x] Fixed pixel size calculation in useEffect to use gridWidth and gridHeight
  - [x] Updated select tool boundary checks to use gridWidth and gridHeight
  - [x] Fixed canvas size calculation to use Math.max(gridWidth, gridHeight)
  - [x] Updated usePixelCanvas gridSize parameter to use actual gridWidth
  - [x] Prevented "Cannot set properties of undefined" error when drawing on larger canvases
  - [x] Canvas now properly supports dynamic sizes from 8×8 to 256×256 pixels
  - [x] All 96 files passed lint checks
- [x] Step 26: Fix gridWidth undefined reference error (Completed)
  - [x] Identified error: "Uncaught ReferenceError: gridWidth is not defined at handleTouchEnd"
  - [x] Found duplicate gridHeight and gridWidth definitions inside getPixelCoords function
  - [x] Removed redundant local variable declarations at lines 119-120
  - [x] getPixelCoords now uses component-level gridWidth and gridHeight variables
  - [x] Eliminated variable shadowing issue that caused scope problems
  - [x] Fixed reference error in canvasSize calculation at line 343
  - [x] All touch and mouse events now properly access grid dimensions
  - [x] All 96 files passed lint checks
- [x] Step 27: Remove select and move tools, relocate Canvas Size and Export buttons (Completed)
  - [x] Removed "select" and "move" from Tool type definition in pixel-art.ts
  - [x] Deleted SelectionToolbar component file (no longer needed)
  - [x] Removed SelectionToolbar import from PixelArtEditor.tsx
  - [x] Removed all "select" tool handling code from PixelCanvas.tsx handleStart function
  - [x] Removed all "move" tool handling code from PixelCanvas.tsx handleStart function
  - [x] Removed "select" tool preview logic from PixelCanvas.tsx handleMove function
  - [x] Removed "move" tool preview logic from PixelCanvas.tsx handleMove function
  - [x] Removed "select" tool finalization code from PixelCanvas.tsx handleEnd function
  - [x] Removed "move" tool finalization code from PixelCanvas.tsx handleEnd function
  - [x] Removed "m" keyboard shortcut for select tool from use-keyboard-shortcuts.ts
  - [x] Removed Canvas Size and Export buttons from header section
  - [x] Moved Canvas Size button to toolbar Row 2, left side before Undo button
  - [x] Moved Export button to toolbar Row 2, left side before Undo button
  - [x] Changed Canvas Size and Export buttons to icon-only format (size="icon")
  - [x] Applied consistent pixel-button styling to relocated buttons
  - [x] Updated button sizes to h-11 w-11 (mobile) and h-10 w-10 (desktop)
  - [x] Added tooltips: "Canvas Size" and "Export PNG"
  - [x] Removed SelectionToolbar from Row 2 layout
  - [x] Updated Row 2 comment to reflect new layout: "Canvas Size, Export + Actions"
  - [x] All 95 files passed lint checks
- [x] Step 28: Optimize export pixel size for minimum 100KB file size (Completed)
  - [x] Replaced fixed 8x export scale with dynamic calculation algorithm
  - [x] Implemented smart scaling: calculates optimal scale based on canvas dimensions
  - [x] Target: 500,000 pixels in exported image to ensure 100KB+ PNG file size
  - [x] Formula: scale = sqrt(500,000 / (width × height))
  - [x] Applied minimum scale factor of 16x for small canvases
  - [x] Applied maximum scale factor of 32x to prevent excessive file sizes
  - [x] Rounds calculated scale to nearest integer for clean pixel multiplication
  - [x] Added console logging: displays canvas size, scale factor, and output dimensions
  - [x] Examples: 32×32 canvas → 22x scale → 704×704 output (~495K pixels)
  - [x] Examples: 64×64 canvas → 16x scale → 1024×1024 output (~1M pixels)
  - [x] Examples: 128×128 canvas → 16x scale → 2048×2048 output (~4M pixels)
  - [x] Maintains crisp pixel art quality with imageSmoothingEnabled = false
  - [x] Preserves maximum PNG quality setting (1.0)
  - [x] All 95 files passed lint checks
- [x] Step 29: Add zoom button with dropdown menu to first row (Completed)
  - [x] Changed zoom from constant (useState(1)) to stateful (setZoom)
  - [x] Added ZoomIn, ZoomOut, Maximize icons to lucide-react imports
  - [x] Implemented handleZoomIn function: increases zoom by 0.25, max 4x
  - [x] Implemented handleZoomOut function: decreases zoom by 0.25, min 0.5x
  - [x] Implemented handleZoomFit function: resets zoom to 1x (fit to screen)
  - [x] Added zoom DropdownMenu component after drawing tools in Row 1
  - [x] Applied pixel-button styling with h-11 w-11 sm:h-10 sm:w-10 dimensions
  - [x] Added flex-shrink-0 to prevent button compression
  - [x] Used ZoomIn icon for dropdown trigger button
  - [x] Applied pixel-card styling to dropdown content with border-4
  - [x] Added dropdown label showing current zoom percentage (e.g., "ZOOM (100%)")
  - [x] Applied font-pixel class to label with text-primary and text-xs
  - [x] Added DropdownMenuSeparator with bg-border h-1 styling
  - [x] Created "Zoom In" menu item with ZoomIn icon, disabled when zoom >= 4x
  - [x] Created "Zoom Out" menu item with ZoomOut icon, disabled when zoom <= 0.5x
  - [x] Created "Fit" menu item with Maximize icon to reset zoom to 1x
  - [x] Applied font-retro text-base to all menu items
  - [x] Added hover and focus states: hover:bg-primary hover:text-primary-foreground
  - [x] Positioned zoom button in Row 1 after drawing tools, before Row 2
  - [x] All 95 files passed lint checks
- [x] Step 30: Fix React DOM removeChild error in LayerPanel (Completed)
  - [x] Identified error: "Uncaught NotFoundError: Failed to execute 'removeChild' on 'Node'"
  - [x] Root cause: Improper JSX structure in Button component (line 59)
  - [x] Issue: Button content wrapped in JSX expression {"New "} without Plus icon
  - [x] Fixed Button structure to properly include Plus icon and text together
  - [x] Added Plus icon with className "h-4 w-4 mr-1" inside Button
  - [x] Changed text from {"New "} to plain "New" text node
  - [x] Preserved user's custom styling: h-8 mr-[50px] bg-[#99c8f3] bg-none
  - [x] Resolved React virtual DOM reconciliation issue
  - [x] All 95 files passed lint checks
- [x] Step 31: Update background image for main container (Completed)
  - [x] Updated background image URL to IMG-8z4wrlhevlds.jpg
  - [x] Preserved background styling: bg-cover bg-center bg-no-repeat
  - [x] Maintained container margins: mt-[0px] ml-[5px] mr-[5px]
  - [x] Applied to main container div with className "fixed inset-0 flex flex-col overflow-hidden pixel-grid"
  - [x] Background image URL: https://miaoda-edit-image.s3cdn.medo.dev/8ydy3wce8yrl/IMG-8z4wrlhevlds.jpg
  - [x] All 95 files passed lint checks
- [x] Step 32: Add permanent border to canvas area (Completed)
  - [x] Added border-4 border-border classes to canvas area container
  - [x] Applied to canvas container at line 733 in PixelArtEditor.tsx
  - [x] Border style: 4px solid border using semantic border-border color
  - [x] Preserved existing canvas container classes: flex-1 flex items-center justify-center overflow-hidden p-2 sm:p-4 @container
  - [x] Canvas area now always displays with visible border frame
  - [x] All 95 files passed lint checks
- [x] Step 33: Fix hexToRgba undefined color error (Completed)
  - [x] Identified error: "Cannot read properties of undefined (reading 'slice')" in blend-modes.ts
  - [x] Root cause: hexToRgba function didn't handle undefined/null color values
  - [x] Added null/undefined check: if (!hex || hex === "transparent")
  - [x] Function now returns [0, 0, 0, 0] for undefined, null, or transparent colors
  - [x] Prevents .slice() being called on undefined values
  - [x] Fixed error chain: hexToRgba → blendColors → createEmptyCanvas → mergeLayers
  - [x] All 95 files passed lint checks
- [x] Step 34: Create welcoming front page with animations and canvas size selection (Completed)
  - [x] Created new WelcomePage component at src/pages/WelcomePage.tsx
  - [x] Added animated hero section with Pixel Art Pro branding
  - [x] Implemented bouncing logo animation with glow effect
  - [x] Added animated gradient background with pixel grid overlay
  - [x] Created canvas size selection grid with 6 options: 8×8, 16×16, 32×32, 64×64, 128×128, 256×256
  - [x] Added size descriptions: Tiny, Small, Medium, Large, XL, XXL
  - [x] Implemented interactive size selection with hover and active states
  - [x] Added pulse animation to selected canvas size option
  - [x] Created "START DRAWING" button with bounce animation
  - [x] Added feature pills showing: Layers, Blend Modes, Advanced Tools
  - [x] Implemented 9 custom CSS animations: fade-in, slide-down, slide-up, bounce-slow, bounce-subtle, pixel-glow, gradient, and delayed variants
  - [x] Added staggered animation delays for smooth entrance effects
  - [x] Created pixel-card-sm utility class for small card shadows
  - [x] Updated PixelArtEditor to accept canvas size from URL params (?size=32)
  - [x] Added useSearchParams hook to read size parameter
  - [x] Updated initialState to use initialSize from URL params
  - [x] Modified routes.tsx to add welcome page at "/" and editor at "/editor"
  - [x] Implemented navigation from welcome page to editor with selected canvas size
  - [x] Added 300ms transition animation before navigation
  - [x] All 96 files passed lint checks

## Features Implemented

### Core Drawing Tools
- **Pencil**: Draw single pixels (P)
- **Eraser**: Remove pixel color (E)
- **Fill**: Flood fill with contiguous/global modes (F)
- **Eyedropper**: Sample colors from canvas (I)

### Shape Primitives
- **Line Tool**: Bresenham's line algorithm for pixel-perfect lines (L)
- **Circle Tool**: Midpoint circle algorithm for perfect circles (C)
- **Square Tool**: Rectangle drawing with outline mode (R)

### Selection Tools
- **Marquee**: Rectangular selection (M)
- **Lasso**: Freeform selection with polygon detection (L)
- **Move**: Move selected pixels (V)
- **Hand**: Pan canvas for navigation (H)

### Clipboard Operations
- **Copy**: Ctrl+C - Copy selection to clipboard
- **Cut**: Ctrl+X - Cut selection to clipboard
- **Paste**: Ctrl+V - Paste clipboard content

### Transformations
- **Rotate**: 90° clockwise rotation
- **Flip Horizontal**: Mirror horizontally
- **Flip Vertical**: Mirror vertically

### Fill Modes
- **Contiguous**: Fill connected pixels only (default)
- **Global**: Replace all instances of a color

### Layer System
- **Create Layer**: Add new transparent layer
- **Delete Layer**: Remove layer (minimum 1 layer required)
- **Duplicate Layer**: Copy layer with all properties
- **Reorder Layers**: Drag-and-drop to change layer order
- **Opacity**: Adjustable 0-100% per layer
- **Visibility**: Toggle layer visibility (eye icon)
- **Lock**: Prevent editing locked layers (lock icon)
- **Alpha Lock**: Paint only on non-transparent pixels
- **Blend Modes**: 12 compositing modes
  - Normal
  - Multiply
  - Screen
  - Overlay
  - Darken
  - Lighten
  - Color Dodge
  - Color Burn
  - Hard Light
  - Soft Light
  - Difference
  - Exclusion
- **Layer Naming**: Double-click to rename layers
- **Active Layer**: Highlighted with border, shown in status bar

### Color & Palette Management
- **Enhanced Color Picker**:
  - Hex code input with validation
  - RGB sliders (0-255 for R, G, B)
  - HSV sliders (H: 0-360°, S: 0-100%, V: 0-100%)
  - HTML5 color picker integration
  - Real-time color preview
  - Quick palette (16 preset colors)
- **Palette Manager**:
  - Create custom palettes with names
  - Save/load palettes
  - Import palettes (JSON, GPL/GIMP format)
  - Export palettes (JSON, GPL format)
  - Drag-and-drop color reordering
  - Add colors to palette
  - Remove colors from palette
  - Default palettes: Default (16 colors), Grayscale (12 shades), PICO-8 (16 colors)
  - Multiple palette support with switcher
  - Delete custom palettes (keep at least one)
- **Color Utilities**:
  - RGB ↔ Hex conversion
  - RGB ↔ HSV conversion
  - Hue shifting for rainbow mode
  - Color validation

### Dynamic Brush Modes
- **Normal Mode**: Standard pixel-by-pixel drawing
- **Rainbow Mode**: Automatically cycles hue with each stroke for gradient effects
- **Random Mode**: Picks random color from active palette for each pixel
- **Dither Mode**: Applies Bayer matrix dithering patterns for texturing
  - Bayer 2×2 (fine pattern)
  - Bayer 4×4 (medium pattern)
  - Bayer 8×8 (coarse pattern)
- **Brush Mode Selector**: Visual buttons with icons and descriptions
- **Status Display**: Shows active brush mode in bottom toolbar

### Navigation
- **Pan**: Hand tool for canvas navigation
- **Zoom**: Zoom support (1x default, extensible)
- **Grid Toggle**: Show/hide pixel grid (G)

### History
- **Undo**: Ctrl+Z (20 steps, includes layer changes)
- **Redo**: Ctrl+Y / Ctrl+Shift+Z (20 steps)

## Keyboard Shortcuts
- **P**: Pencil tool
- **E**: Eraser tool
- **F**: Fill tool
- **I**: Eyedropper tool
- **L**: Line tool
- **C**: Circle tool
- **R**: Square/Rectangle tool
- **M**: Marquee selection
- **H**: Hand/Pan tool
- **G**: Toggle grid
- **Ctrl+Z**: Undo
- **Ctrl+Y**: Redo
- **Ctrl+C**: Copy selection
- **Ctrl+X**: Cut selection
- **Ctrl+V**: Paste

## Technical Implementation
- Integer-based algorithms (Bresenham, Midpoint) for anti-aliasing-free shapes
- Dual-canvas system (main + overlay) for selection visualization
- Touch and mouse event support
- Responsive canvas sizing
- Mobile-optimized drawer interface
- 20-step undo/redo history with full layer and palette state
- Clipboard system for copy/cut/paste operations
- Real-time shape preview during drawing
- Layer compositing with blend modes and opacity
- Drag-and-drop layer reordering
- Alpha lock for precise pixel editing
- Layer merging for final display
- Color space conversions (RGB, HSV, Hex)
- Palette import/export (JSON, GPL formats)
- Bayer matrix dithering algorithms (2x2, 4x4, 8x8)
- Dynamic brush mode system
- Palette state management with undo/redo support
- Comprehensive error handling for browser extension conflicts
- Object.defineProperty override to prevent descriptor conflicts
- Global error handlers in index.html and main.tsx
- React Error Boundary component for graceful error recovery
- Extension error suppression to prevent application crashes
- window.onerror handler for additional error catching

## Notes
- MVP focuses on 32×32 canvas with comprehensive toolset, layer system, and color management
- No backend/database needed - fully client-side
- Export as PNG with transparent background support (merges all visible layers)
- Custom vibrant color scheme with purple primary and orange secondary
- All lint checks passed successfully (95 files)
- Fully optimized for mobile devices with touch-friendly controls
- Responsive layout: stacked toolbar on mobile, single row on desktop
- Touch targets meet iOS guidelines (44x44px minimum on mobile)
- Horizontal scrolling for tools on small screens
- Full-width sheets on mobile for better usability
- Canvas automatically resizes to fit viewport with optimized padding
- Prevents body scrolling on mobile devices
- Active touch feedback for better mobile interaction
- Selection overlay with animated dashed border
- Shape tools show preview before finalizing
- Layer panel accessible via Layers button in top toolbar
- Active layer name and status shown in bottom status bar (condensed on mobile)
- Locked layers prevent all editing operations
- Alpha lock restricts painting to existing pixels only
- Blend modes use proper color compositing algorithms and are now visible during editing
- Layer opacity applies during final compositing
- Canvas displays merged layers with all blend modes and opacity applied in real-time
- Color picker with tabbed interface (Color, Palette, Brush)
- Palettes support drag-and-drop color reordering
- GPL format compatible with GIMP and other tools
- Brush modes shown in status bar
- Rainbow mode uses HSV color space for smooth hue transitions
- Random mode respects active palette colors
- Dither mode uses industry-standard Bayer matrices
- All palette operations integrated with undo/redo system
- Undo/redo functionality working correctly with 20-step history using refs to avoid stale closures
- History hook uses refs (historyRef, currentIndexRef) to track latest values and prevent race conditions
- All React hooks follow proper ordering rules to prevent "Rendered more hooks" errors
- Hook call order: useState → useMemo → useHistory → useKeyboardShortcuts → useEffect
- Defensive object creation to prevent property descriptor conflicts with browser extensions
- All factory functions (createLayer, createPalette, duplicateLayer) return plain objects
- State initialization wrapped in try-catch for graceful error handling
- Multi-layer error handling: Object.defineProperty override, inline script in HTML, global handlers in main.tsx, React Error Boundary
- Object.defineProperty is overridden to automatically fix conflicting descriptor properties
- Chrome extension errors are caught and suppressed at multiple levels to prevent application crashes
- Error Boundary provides user-friendly fallback UI for unexpected errors
- Console.error is intercepted to filter out extension-related errors
- window.onerror handler provides additional error catching layer
- Property descriptor conflicts are automatically resolved by removing conflicting properties
- UI reorganized with controls at top for better accessibility
- Larger, more visible icons and buttons for improved usability
- Quick Export button prominently placed in header
- Drawing tools and selection tools in single row with visual separator
- Shapes consolidated into dropdown menu (Line, Circle, Rectangle)
- Color selector enlarged with hover effect for better visibility
- Action buttons (Undo/Redo/Layers/Settings) grouped on right side
- Status bar at bottom shows current tool and layer information
- Mobile-optimized with responsive breakpoints and touch-friendly interactions
